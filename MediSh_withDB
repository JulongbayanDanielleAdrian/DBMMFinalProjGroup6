import sqlite3
from kivy.app import App
from kivy.uix.gridlayout import GridLayout
from kivy.uix.label import Label
from kivy.uix.image import Image
from kivy.uix.button import Button
from kivy.uix.textinput import TextInput
from kivy.uix.widget import Widget
# Builder.load_file("test.kv")

class MediShit(App):
    def build(self):
        self.create_db()

        self.window = GridLayout(cols=1, size_hint=(0.4, 0.6), pos_hint={"center_x": 0.5, "center_y": 0.5})

        # Logo
        self.window.add_widget(Image(source="MediShit.png"))

        # Greeting Label
        self.greeting = Label(text="Welcome to MediSh*t! (???)", font_size="25", color="#00a8f3")
        self.window.add_widget(self.greeting)

        # Username input
        self.username = TextInput(hint_text="Username", multiline=False, padding_y=(10, 10), size_hint=(1, 0.5))
        self.window.add_widget(self.username)

        # Password input (hidden)
        self.password = TextInput(hint_text="Password", multiline=False, password=True,
                                  padding_y=(10, 10), size_hint=(1, 0.5))
        self.window.add_widget(self.password)

        # Spacer
        self.window.add_widget(Widget(size_hint_y=None, height=20))

        # Register/Login Button
        self.button = Button(text="Register/Login", size_hint=(1, 0.5), bold=True, background_color="#00a8f3")
        self.button.bind(on_press=self.callback)
        self.window.add_widget(self.button)

        return self.window

    def create_db(self):
        # Create a SQLite DB and users table if it doesn't exist
        self.conn = sqlite3.connect("users.db")
        self.cursor = self.conn.cursor()
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS users (
                username TEXT PRIMARY KEY,
                password TEXT NOT NULL
            )
        """)
        self.conn.commit()

    def callback(self, instance):
        username = self.username.text.strip()
        password = self.password.text.strip()

        if not username or not password:
            self.greeting.text = "Please fill in all fields."
            return

        self.cursor.execute("SELECT * FROM users WHERE username = ?", (username,))
        user = self.cursor.fetchone()

        if user:
            if user[1] == password:
                self.greeting.text = f"Welcome back, {username}!"
            else:
                self.greeting.text = "Wrong password!"
        else:
            self.cursor.execute("INSERT INTO users (username, password) VALUES (?, ?)", (username, password))
            self.conn.commit()
            self.greeting.text = f"Account created! Welcome, {username}!"

if __name__ == "__main__":
    MediShit().run()
